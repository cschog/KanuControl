<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
          http://www.liquibase.org/xml/ns/dbchangelog
          http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.23.xsd">

    <!-- ========================================================= -->
    <!-- PERSON -->
    <!-- ========================================================= -->
    <changeSet id="baseline-001-person" author="chris">
        <createTable tableName="person">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>

            <column name="vorname" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>

            <column name="geburtsdatum" type="DATE"/>
            <column name="sex" type="CHAR(1)">
                <constraints nullable="false"/>
            </column>

            <column name="email" type="VARCHAR(255)"/>

            <column name="aktiv" type="BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>

            <column name="strasse" type="VARCHAR(255)"/>
            <column name="plz" type="VARCHAR(20)"/>
            <column name="ort" type="VARCHAR(100)"/>
            <column name="country_code" type="CHAR(2)"/>
            <column name="telefon" type="VARCHAR(50)"/>
            <column name="telefon_festnetz" type="VARCHAR(50)"/>

            <column name="bank_name" type="VARCHAR(255)"/>
            <column name="iban" type="VARCHAR(34)"/>

            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(255)"/>
            <column name="last_modified_at" type="TIMESTAMP"/>
            <column name="last_modified_by" type="VARCHAR(255)"/>
        </createTable>

        <addUniqueConstraint
                tableName="person"
                columnNames="name, vorname, geburtsdatum"
                constraintName="ux_person_name_vorname_geburtsdatum"/>

        <sql>
            ALTER TABLE person
            ADD CONSTRAINT ck_person_sex CHECK (sex IN ('M','W','D'));
        </sql>

        <createIndex tableName="person" indexName="idx_person_aktiv">
            <column name="aktiv"/>
        </createIndex>

        <!-- Case-insensitive identity -->
        <sql>
            CREATE UNIQUE INDEX ux_person_identity
            ON person (lower(name), lower(vorname), geburtsdatum)
            WHERE geburtsdatum IS NOT NULL;
        </sql>
    </changeSet>

    <!-- ========================================================= -->
    <!-- VEREIN -->
    <!-- ========================================================= -->
    <changeSet id="baseline-002-verein" author="chris">
        <createTable tableName="verein">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>

            <column name="abk" type="VARCHAR(10)">
                <constraints nullable="false"/>
            </column>

            <column name="strasse" type="VARCHAR(255)"/>
            <column name="plz" type="VARCHAR(20)"/>
            <column name="ort" type="VARCHAR(100)"/>
            <column name="telefon" type="VARCHAR(50)"/>

            <column name="bank_name" type="VARCHAR(255)"/>
            <column name="iban" type="VARCHAR(34)"/>

            <column name="kontoinhaber_id" type="BIGINT"/>

            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(100)"/>
            <column name="last_modified_at" type="TIMESTAMP"/>
            <column name="last_modified_by" type="VARCHAR(100)"/>
        </createTable>

        <addForeignKeyConstraint
                constraintName="fk_verein_kontoinhaber"
                baseTableName="verein"
                baseColumnNames="kontoinhaber_id"
                referencedTableName="person"
                referencedColumnNames="id"
                onDelete="RESTRICT"/>

        <createIndex tableName="verein" indexName="idx_verein_kontoinhaber">
            <column name="kontoinhaber_id"/>
        </createIndex>

        <sql>
            CREATE UNIQUE INDEX ux_verein_identity
            ON verein (lower(abk), lower(name));
        </sql>
    </changeSet>

    <!-- ========================================================= -->
    <!-- VERANSTALTUNG -->
    <!-- ========================================================= -->
    <changeSet id="baseline-003-veranstaltung" author="chris">
        <createTable tableName="veranstaltung">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="name" type="VARCHAR(200)">
                <constraints nullable="false"/>
            </column>

            <column name="typ" type="CHAR(3)">
                <constraints nullable="false"/>
            </column>

            <column name="art_der_unterkunft" type="VARCHAR(200)"/>
            <column name="art_der_verpflegung" type="VARCHAR(200)"/>

            <column name="plz" type="VARCHAR(20)"/>
            <column name="ort" type="VARCHAR(200)"/>
            <column name="country_code" type="CHAR(2)"/>

            <column name="beginn_datum" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="beginn_zeit" type="TIME">
                <constraints nullable="false"/>
            </column>
            <column name="ende_datum" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="ende_zeit" type="TIME">
                <constraints nullable="false"/>
            </column>

            <column name="verein_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="leiter_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="geplante_teilnehmer_maennlich" type="INTEGER"/>
            <column name="geplante_teilnehmer_weiblich" type="INTEGER"/>
            <column name="geplante_teilnehmer_divers" type="INTEGER"/>
            <column name="geplante_mitarbeiter_maennlich" type="INTEGER"/>
            <column name="geplante_mitarbeiter_weiblich" type="INTEGER"/>
            <column name="geplante_mitarbeiter_divers" type="INTEGER"/>

            <column name="aktiv" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(255)"/>
            <column name="last_modified_at" type="TIMESTAMP"/>
            <column name="last_modified_by" type="VARCHAR(255)"/>
        </createTable>

        <addForeignKeyConstraint
                constraintName="fk_veranstaltung_verein"
                baseTableName="veranstaltung"
                baseColumnNames="verein_id"
                referencedTableName="verein"
                referencedColumnNames="id"
                onDelete="RESTRICT"/>

        <addForeignKeyConstraint
                constraintName="fk_veranstaltung_leiter"
                baseTableName="veranstaltung"
                baseColumnNames="leiter_id"
                referencedTableName="person"
                referencedColumnNames="id"
                onDelete="RESTRICT"/>
    </changeSet>

    <!-- ========================================================= -->
    <!-- TEILNEHMER -->
    <!-- ========================================================= -->
    <changeSet id="baseline-004-teilnehmer" author="chris">
        <createTable tableName="teilnehmer">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="veranstaltung_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="person_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="rolle" type="CHAR(1)"/>

            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(255)"/>
            <column name="last_modified_at" type="TIMESTAMP"/>
            <column name="last_modified_by" type="VARCHAR(255)"/>
        </createTable>

        <addForeignKeyConstraint
                constraintName="fk_teilnehmer_veranstaltung"
                baseTableName="teilnehmer"
                baseColumnNames="veranstaltung_id"
                referencedTableName="veranstaltung"
                referencedColumnNames="id"
                onDelete="CASCADE"/>

        <addForeignKeyConstraint
                constraintName="fk_teilnehmer_person"
                baseTableName="teilnehmer"
                baseColumnNames="person_id"
                referencedTableName="person"
                referencedColumnNames="id"
                onDelete="RESTRICT"/>

        <addUniqueConstraint
                tableName="teilnehmer"
                columnNames="veranstaltung_id, person_id"
                constraintName="uk_teilnehmer_veranstaltung_person"/>

        <createIndex tableName="teilnehmer" indexName="idx_teilnehmer_veranstaltung">
            <column name="veranstaltung_id"/>
        </createIndex>

        <createIndex tableName="teilnehmer" indexName="idx_teilnehmer_person">
            <column name="person_id"/>
        </createIndex>

        <!-- ðŸ” GENAU EIN LEITER PRO VERANSTALTUNG -->
        <sql>
            CREATE UNIQUE INDEX ux_teilnehmer_single_leiter
            ON teilnehmer (veranstaltung_id)
            WHERE rolle = 'L';
        </sql>
    </changeSet>

    <!-- ========================================================= -->
    <!-- ERHEBUNGSBOGEN -->
    <!-- ========================================================= -->
    <changeSet id="baseline-005-erhebungsbogen" author="chris">
        <createTable tableName="erhebungsbogen">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="veranstaltung_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="abgeschlossen" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>

            <column name="stichtag" type="DATE">
                <constraints nullable="false"/>
            </column>

            <column name="teilnehmer_maennlich_u6" type="INTEGER"/>
            <column name="teilnehmer_maennlich_6_13" type="INTEGER"/>
            <column name="teilnehmer_maennlich_14_17" type="INTEGER"/>
            <column name="teilnehmer_maennlich_18_plus" type="INTEGER"/>

            <column name="teilnehmer_weiblich_u6" type="INTEGER"/>
            <column name="teilnehmer_weiblich_6_13" type="INTEGER"/>
            <column name="teilnehmer_weiblich_14_17" type="INTEGER"/>
            <column name="teilnehmer_weiblich_18_plus" type="INTEGER"/>

            <column name="teilnehmer_divers_u6" type="INTEGER"/>
            <column name="teilnehmer_divers_6_13" type="INTEGER"/>
            <column name="teilnehmer_divers_14_17" type="INTEGER"/>
            <column name="teilnehmer_divers_18_plus" type="INTEGER"/>

            <column name="mitarbeiter_maennlich" type="INTEGER"/>
            <column name="mitarbeiter_weiblich" type="INTEGER"/>
            <column name="mitarbeiter_divers" type="INTEGER"/>

            <column name="bemerkung" type="VARCHAR(500)"/>

            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(100)"/>
            <column name="last_modified_at" type="TIMESTAMP"/>
            <column name="last_modified_by" type="VARCHAR(100)"/>
        </createTable>

        <addUniqueConstraint
                tableName="erhebungsbogen"
                columnNames="veranstaltung_id"
                constraintName="uk_erhebungsbogen_veranstaltung"/>

        <addForeignKeyConstraint
                constraintName="fk_erhebungsbogen_veranstaltung"
                baseTableName="erhebungsbogen"
                baseColumnNames="veranstaltung_id"
                referencedTableName="veranstaltung"
                referencedColumnNames="id"
                onDelete="RESTRICT"/>
    </changeSet>

    <!-- ========================================================= -->
    <!-- MITGLIED -->
    <!-- ========================================================= -->
    <changeSet id="baseline-006-mitglied" author="chris">
        <createTable tableName="mitglied">
            <column name="id" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>

            <column name="person_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="verein_id" type="BIGINT">
                <constraints nullable="false"/>
            </column>

            <column name="funktion" type="VARCHAR(50)"/>
            <column name="haupt_verein" type="BOOLEAN">
                <constraints nullable="false"/>
            </column>

            <column name="created_at" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="VARCHAR(100)"/>
            <column name="last_modified_at" type="TIMESTAMP"/>
            <column name="last_modified_by" type="VARCHAR(100)"/>
        </createTable>

        <addUniqueConstraint
                tableName="mitglied"
                columnNames="person_id, verein_id"
                constraintName="uk_mitglied_person_verein"/>

        <addForeignKeyConstraint
                constraintName="fk_mitglied_person"
                baseTableName="mitglied"
                baseColumnNames="person_id"
                referencedTableName="person"
                referencedColumnNames="id"
                onDelete="CASCADE"/>

        <addForeignKeyConstraint
                constraintName="fk_mitglied_verein"
                baseTableName="mitglied"
                baseColumnNames="verein_id"
                referencedTableName="verein"
                referencedColumnNames="id"
                onDelete="CASCADE"/>

        <createIndex tableName="mitglied" indexName="idx_mitglied_person">
            <column name="person_id"/>
        </createIndex>

        <createIndex tableName="mitglied" indexName="idx_mitglied_verein">
            <column name="verein_id"/>
        </createIndex>

        <createIndex tableName="mitglied" indexName="idx_mitglied_hauptverein">
            <column name="haupt_verein"/>
        </createIndex>
    </changeSet>

</databaseChangeLog>